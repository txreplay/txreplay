<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Music App</title>
</head>
<body>
<div class="container" style="margin-top: 10px">
    <div>
        <p>
            <button type="button" class="btn btn-lg btn-default" onclick="init()">Grab audio</button>
        </p>

        <!--<audio controls autoplay muted></audio>-->
    </div>
</div>

<script src="js/three.js"></script>
<script id="vertexShader" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
        vUv = uv;
        gl_Position = vec4(position, 0.5);
    }
</script>
<script id="fragmentShader" type="x-shader/x-fragment">
    uniform sampler2D tAudioData;
    varying vec2 vUv;
    void main() {
        vec3 backgroundColor = vec3(0.0, 0.0, 0.0);
        vec3 color = vec3(1.0, 1.0, 1.0);
        float f = texture2D(tAudioData, vec2(vUv.x, 0.0)).r;
        float i = step(vUv.y, f) * step(f - 0.0125, vUv.y);
        gl_FragColor = vec4(mix(backgroundColor, color, i), 1.0);
    }
</script>
<script>
    let _scene, _camera, _renderer, _analyser, _uniforms;
    let _listener, _audio, _mediaElement;
    let _material, _geometry, _mesh;

    const $container = document.querySelector('.container');

    function init() {
        const fftSize = 64;

        _renderer = new THREE.WebGLRenderer({antialias: true});
        _renderer.setSize(500, 500);

        $container.appendChild(_renderer.domElement);

        _scene = new THREE.Scene();
        _camera = new THREE.Camera();

        _listener = new THREE.AudioListener();
        _audio = new THREE.Audio(_listener);
        _mediaElement = new Audio('./music.mp3');
        _mediaElement.loop = true;
        _mediaElement.play();
        _audio.setMediaElementSource(_mediaElement);
        _analyser = new THREE.AudioAnalyser(_audio, fftSize);

        _uniforms = {
            tAudioData: {value: new THREE.DataTexture(_analyser.data, fftSize / 2, 1, THREE.LuminanceFormat)}
        };

        _material = new THREE.ShaderMaterial({
            uniforms: _uniforms,
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent
        });

        _geometry = new THREE.BoxBufferGeometry(1, 1, 1);
        _mesh = new THREE.Mesh(_geometry, _material);
        _scene.add(_mesh);

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        render();
    }

    function render() {
        _analyser.getFrequencyData();
        _uniforms.tAudioData.value.needsUpdate = true;
        _renderer.render(_scene, _camera);
    }
</script>
</body>
</html>